<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Appointment</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/appointment-edit.css}">
</head>
<body>
    <div th:replace="~{layout/main :: header}"></div>
    <div class="content-container">
        <div class="content-header">
            <h1>
                <span th:if="${appointment.id}">Edit Appointment</span>
                <span th:unless="${appointment.id}">New Appointment</span>
            </h1>
            <div class="header-buttons">
                <a href="/appointments" class="btn btn-secondary">Back to Appointments</a>
            </div>
        </div>
        
        <div id="alerts"></div>
        
        <div class="form-container">
            <form id="appointmentForm" th:action="@{/appointments/save}" method="post" th:object="${appointment}">
                <input type="hidden" id="appointmentId" th:field="*{id}">
                
                <div class="form-section">
                    <h3>Patient Information</h3>
                    <div class="form-group">
                        <label for="patientSearch">Patient</label>
                        <div class="search-container">
                            <input type="text" id="patientSearch" class="form-control" placeholder="Search for patient..." 
                                   th:value="${appointment.patient != null ? appointment.patient.firstName + ' ' + appointment.patient.lastName : ''}">
                            <input type="hidden" id="patientId" th:field="*{patientId}">
                            <div id="patientSearchResults" class="search-results"></div>
                        </div>
                    </div>
                    
                    <div id="patientInfo" class="info-container" th:classappend="${appointment.patient != null ? 'visible' : ''}">
                        <div th:if="${appointment.patient != null}">
                            <div class="info-row">
                                <div class="info-label">Name:</div>
                                <div th:text="${appointment.patient.firstName + ' ' + appointment.patient.lastName}"></div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">ID:</div>
                                <div th:text="${appointment.patient.id}"></div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Date of Birth:</div>
                                <div th:text="${appointment.patient.dateOfBirth}"></div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Contact:</div>
                                <div th:text="${appointment.patient.phone ?: 'N/A'}"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Doctor Information</h3>
                    <div class="form-group">
                        <label for="doctorSearch">Doctor</label>
                        <div class="search-container">
                            <input type="text" id="doctorSearch" class="form-control" placeholder="Search for doctor..." 
                                   th:value="${appointment.doctor != null ? 'Dr. ' + appointment.doctor.firstName + ' ' + appointment.doctor.lastName : ''}">
                            <input type="hidden" id="doctorId" th:field="*{doctorId}">
                            <div id="doctorSearchResults" class="search-results"></div>
                        </div>
                    </div>
                    
                    <div id="doctorInfo" class="info-container" th:classappend="${appointment.doctor != null ? 'visible' : ''}">
                        <div th:if="${appointment.doctor != null}">
                            <div class="info-row">
                                <div class="info-label">Name:</div>
                                <div th:text="${'Dr. ' + appointment.doctor.firstName + ' ' + appointment.doctor.lastName}"></div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">ID:</div>
                                <div th:text="${appointment.doctor.id}"></div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Specialty:</div>
                                <div th:text="${appointment.doctor.specialty ?: 'N/A'}"></div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Department:</div>
                                <div th:text="${appointment.doctor.department ?: 'N/A'}"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Appointment Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appointmentDate">Date</label>
                            <input type="text" id="appointmentDate" class="form-control" th:field="*{appointmentDate}" placeholder="Select date">
                        </div>
                        <div class="form-group">
                            <label for="appointmentTime">Time</label>
                            <input type="text" id="appointmentTime" class="form-control" th:field="*{appointmentTime}" placeholder="Select time">
                        </div>
                        <div class="form-group">
                            <label for="appointmentDuration">Duration (minutes)</label>
                            <select id="appointmentDuration" class="form-select" th:field="*{duration}">
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                                <option value="60">60</option>
                                <option value="90">90</option>
                                <option value="120">120</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="availabilityMessage" class="availability-message" style="display: none;"></div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appointmentType">Appointment Type</label>
                            <select id="appointmentType" class="form-select" th:field="*{appointmentType}">
                                <option value="">Select Type</option>
                                <option value="CONSULTATION">Consultation</option>
                                <option value="FOLLOW_UP">Follow-up</option>
                                <option value="CHECKUP">Regular Check-up</option>
                                <option value="EMERGENCY">Emergency</option>
                                <option value="PROCEDURE">Procedure</option>
                                <option value="SURGERY">Surgery</option>
                                <option value="THERAPY">Therapy</option>
                                <option value="TEST">Test/Lab</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" class="form-select" th:field="*{status}">
                                <option value="SCHEDULED">Scheduled</option>
                                <option value="CONFIRMED">Confirmed</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="COMPLETED">Completed</option>
                                <option value="CANCELLED">Cancelled</option>
                                <option value="NO_SHOW">No Show</option>
                                <option value="RESCHEDULED">Rescheduled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentReason">Reason</label>
                        <textarea id="appointmentReason" class="form-control" rows="3" th:field="*{reason}" placeholder="Reason for appointment"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" class="form-control" rows="4" th:field="*{notes}" placeholder="Additional notes"></textarea>
                    </div>
                </div>
                
                <div th:if="${appointment.id}" class="form-section">
                    <h3>Status History</h3>
                    <div id="statusHistory" class="timeline-container">
                        <div th:if="${#lists.isEmpty(appointment.statusHistory)}" class="no-history">
                            No status changes recorded
                        </div>
                        <div th:unless="${#lists.isEmpty(appointment.statusHistory)}" class="timeline">
                            <div th:each="statusChange : ${appointment.statusHistory}" class="timeline-item">
                                <div class="timeline-point"></div>
                                <div class="timeline-content">
                                    <h5 th:text="'Status changed to: ' + ${statusChange.status}"></h5>
                                    <p th:text="'By: ' + ${statusChange.user} + ' on ' + ${#temporals.format(statusChange.timestamp, 'dd/MM/yyyy HH:mm')}"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Appointment</button>
                    <a href="/appointments" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    
    <div th:replace="~{layout/main :: footer}"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Custom JS -->
    <script th:src="@{/js/appointment-edit.js}"></script>
</body>
</html> 