<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Timeline - BlackEyeValkyrieSystem</title>
    
    <th:block layout:fragment="head">
        <link rel="stylesheet" th:href="@{/css/appointment-timeline.css}">
        <style>
            /* Timeline styles from appointment-create-visit-info.html */
            .timeline-container {
                background-color: var(--secondary-bg);
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-top: 1rem;
                margin-bottom: 1.5rem;
                width: 100%;
                box-sizing: border-box;
                overflow: hidden !important;
                max-width: 100%;
            }
            
            .timeline-scroll-container {
                overflow-x: auto;
                overflow-y: hidden;
                width: 100%;
                max-width: 100%;
            }
            
            .timeline-content {
                position: relative;
                width: fit-content;
                min-width: min(100%, 800px);
                overflow: visible !important; /* Prevent inner scrollbar */
            }
            
            /* Scrollbar styling for webkit browsers */
            .timeline-scroll-container::-webkit-scrollbar {
                height: 8px;
                width: 8px;
            }
            
            .timeline-scroll-container::-webkit-scrollbar-track {
                background: rgba(138, 43, 226, 0.1);
                border-radius: 4px;
            }
            
            .timeline-scroll-container::-webkit-scrollbar-thumb {
                background-color: var(--accent-color);
                border-radius: 4px;
            }
            
            .timeline-header {
                display: flex;
                margin-bottom: 1rem;
                width: 100%;
            }
            
            .timeline-header h2 {
                margin: 0;
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--primary-text);
                width: 120px;
                min-width: 120px;
                flex-shrink: 0;
                padding-left: 1rem;
            }
            
            .timeline-grid {
                display: flex;
                flex-direction: column;
                width: 100%;
                position: relative;
            }
            
            .doctor-row {
                display: flex;
                margin-bottom: 10px;
                position: relative;
            }
            
            .doctor-column {
                padding: 1rem;
                background-color: var(--secondary-bg);
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                font-weight: 500;
                width: 120px;
                min-width: 120px;
                flex-shrink: 0;
            }
            
            .timeline-time {
                text-align: center;
                font-size: 0.875rem;
                font-weight: 500;
                padding: 0.5rem;
                width: 100px;
                min-width: 100px;
                flex-shrink: 0;
                position: relative;
            }
            
            /* Add line indicators for time markers */
            .timeline-time::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                height: 12px;
                width: 1px;
                background-color: var(--border-color);
            }
            
            .timeline-times {
                display: flex;
                flex-grow: 1;
                max-width: calc(100% - 120px);
                position: relative;
            }
            
            .timeline-slots {
                display: flex;
                flex-grow: 1;
                position: relative;
                height: 80px;
                max-width: calc(100% - 120px);
            }
            
            /* Add vertical grid lines */
            .timeline-slots::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
                background-size: 100px 100%;
                opacity: 0.2;
                pointer-events: none;
            }
            
            .appointment-block {
                background-color: rgba(138, 43, 226, 0.1);
                border-left: 4px solid #8a2be2;
                border-radius: 0.375rem;
                padding: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.875rem;
                height: 80%;
                margin: auto 5px;
                position: absolute;
                top: 10%;
                min-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                box-sizing: border-box;
                z-index: 1;
                cursor: pointer;
            }
            
            .appointment-block.teal {
                background-color: rgba(20, 184, 166, 0.1);
                border-left-color: #14b8a6;
            }
            
            .appointment-block.red {
                background-color: rgba(239, 68, 68, 0.1);
                border-left-color: #ef4444;
            }
            
            /* Force width constraints on all containers */
            html, body, .main-content, .content-container, .timeline-container {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                overflow-x: hidden !important;
            }
            
            /* Only allow scrolling in the designated scroll container */
            .timeline-scroll-container {
                overflow-x: auto !important;
                overflow-y: hidden !important;
            }
            
            /* Make sure the timeline content is properly sized */
            .timeline-content {
                position: relative;
                width: fit-content !important;
                min-width: min(100%, 800px) !important;
                overflow: visible !important;
            }
            
            @media (min-width: 1200px) {
                .timeline-scroll-container:not([data-overflow="true"]) {
                    overflow-x: hidden;
                }
            }
            
            /* Ensure proper responsiveness */
            @media (max-width: 767px) {
                .doctor-column {
                    width: 100px;
                    min-width: 100px;
                    padding: 0.75rem;
                    font-size: 0.875rem;
                }
                
                .timeline-header h2 {
                    width: 100px;
                    min-width: 100px;
                }
                
                .timeline-time {
                    width: 80px;
                    min-width: 80px;
                }
                
                .timeline-slots::before {
                    background-size: 80px 100%;
                }
                
                .timeline-times {
                    max-width: calc(100% - 100px);
                }
                
                .timeline-slots {
                    max-width: calc(100% - 100px);
                }
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="custom-header">
        <header class="header">
            <h1>Appointment Timeline</h1>
            <div class="header-actions">
                <a href="/appointment/create" class="btn btn-primary new-patient-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 3.33334V12.6667" stroke="white" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3.33331 8H12.6666" stroke="white" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Create new appointment
                </a>
            </div>
        </header>
    </div>
    
    <div layout:fragment="content">
        <div class="content-container">
            <!-- Stats Cards -->
            <div class="stats-card-container">
                <!-- Doctors on duty card -->
                <div class="stats-card">
                    <div class="icon purple">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 21V19C16 17.9391 15.5786 16.9217 14.8284 16.1716C14.0783 15.4214 13.0609 15 12 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="#8A2BE2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8.5 11C10.7091 11 12.5 9.20914 12.5 7C12.5 4.79086 10.7091 3 8.5 3C6.29086 3 4.5 4.79086 4.5 7C4.5 9.20914 6.29086 11 8.5 11Z" stroke="#8A2BE2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20 8V14" stroke="#8A2BE2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M23 11H17" stroke="#8A2BE2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="data">
                        <div class="value" th:text="${doctorsOnDuty}">100</div>
                        <div class="label">Doctors on duty</div>
                    </div>
                    <div class="menu-dots">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12C18 12.5523 18.4477 13 19 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Admitted Patients card -->
                <div class="stats-card">
                    <div class="icon teal">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 4H18C18.5304 4 19.0391 4.21071 19.4142 4.58579C19.7893 4.96086 20 5.46957 20 6V20C20 20.5304 19.7893 21.0391 19.4142 21.4142C19.0391 21.7893 18.5304 22 18 22H6C5.46957 22 4.96086 21.7893 4.58579 21.4142C4.21071 21.0391 4 20.5304 4 20V6C4 5.46957 4.21071 4.96086 4.58579 4.58579C4.96086 4.21071 5.46957 4 6 4H8" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15 2H9C8.44772 2 8 2.44772 8 3V5C8 5.55228 8.44772 6 9 6H15C15.5523 6 16 5.55228 16 5V3C16 2.44772 15.5523 2 15 2Z" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 11H12.01" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 15H12.01" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="data">
                        <div class="value" th:text="${admittedPatients}">50</div>
                        <div class="label">Admitted Patients</div>
                    </div>
                    <div class="menu-dots">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12C18 12.5523 18.4477 13 19 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Updated Timeline -->
            <div class="timeline-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Doctors</h2>
                    <div class="date-selector">
                        <span>Date: </span>
                        <input type="date" id="timelineDate" class="date-input">
                    </div>
                </div>
                <div class="timeline-scroll-container">
                    <div class="timeline-content" id="timelineContent">
                        <div class="timeline-header">
                            <h2>Doctors</h2>
                            <div class="timeline-times" id="timelineHeader">
                                <!-- Time slots -->
                                <div class="timeline-time">9:00</div>
                                <div class="timeline-time">9:30</div>
                                <div class="timeline-time">10:00</div>
                                <div class="timeline-time">10:30</div>
                                <div class="timeline-time">11:00</div>
                                <div class="timeline-time">11:30</div>
                                <div class="timeline-time">12:00</div>
                                <div class="timeline-time">12:30</div>
                                <div class="timeline-time">13:00</div>
                                <div class="timeline-time">13:30</div>
                                <div class="timeline-time">14:00</div>
                                <div class="timeline-time">14:30</div>
                                <div class="timeline-time">15:00</div>
                                <div class="timeline-time">15:30</div>
                                <div class="timeline-time">16:00</div>
                                <div class="timeline-time">16:30</div>
                                <div class="timeline-time">17:00</div>
                            </div>
                        </div>
                        
                        <div class="timeline-grid" id="timelineGrid">
                            <!-- Doctor rows will be dynamically generated -->
                            <div class="loading-indicator" id="timelineLoading">
                                <p>Loading appointments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Appointments Section -->
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Pending Appointments</h2>
                    <div class="date-range-selector">
                        <span>Date Range: </span>
                        <input type="date" id="startDate" class="date-input">
                        <span>to</span>
                        <input type="date" id="endDate" class="date-input">
                    </div>
                </div>
                
                <div class="pending-appointments-container">
                    <table class="pending-appointments-table" id="pendingAppointmentsTable">
                        <thead>
                            <tr>
                                <th>Patient Name</th>
                                <th>Doctor</th>
                                <th>Appointment Type</th>
                                <th>Date & Time</th>
                                <th>Duration</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingAppointmentsList">
                            <!-- Pending appointments will be loaded here -->
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <p>Loading pending appointments...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Appointment Timeline page loaded');
                
                // Constants for timeline calculations
                const slotWidth = 100; // Width in pixels of each time slot
                const workStartHour = 9; // 9 AM
                const workEndHour = 17; // 5 PM
                const timeSlots = (workEndHour - workStartHour) * 2 + 1; // 30-minute slots
                
                // Get today's date formatted as YYYY-MM-DD
                function getTodayFormatted() {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // Initialize date inputs with today's date
                const timelineDateInput = document.getElementById('timelineDate');
                if (timelineDateInput) {
                    // Set initial date to today
                    timelineDateInput.value = getTodayFormatted();
                    
                    // Initial load of timeline
                    updateTimeline(timelineDateInput.value);
                    
                    // Auto-fetch data when date loses focus
                    timelineDateInput.addEventListener('blur', function() {
                        if (timelineDateInput.value) {
                            updateTimeline(timelineDateInput.value);
                        }
                    });
                    
                    // Also handle the change event for browser date pickers
                    timelineDateInput.addEventListener('change', function() {
                        if (timelineDateInput.value) {
                            // Small delay to ensure the change is complete
                            setTimeout(() => {
                                updateTimeline(timelineDateInput.value);
                            }, 100);
                        }
                    });
                }
                
                // Set the timeline content width based on time slots
                const timelineContent = document.getElementById('timelineContent');
                const totalWidth = (timeSlots * slotWidth) + 120; // Add doctor column width
                
                if (timelineContent) {
                    timelineContent.style.width = totalWidth + 'px';
                    timelineContent.style.minWidth = Math.min(800, totalWidth) + 'px';
                }
                
                // Check if timeline needs scrollbar
                function checkTimelineOverflow() {
                    const scrollContainer = document.querySelector('.timeline-scroll-container');
                    
                    if (timelineContent && scrollContainer) {
                        // Check if content width exceeds container width
                        const needsScroll = timelineContent.scrollWidth > scrollContainer.clientWidth;
                        scrollContainer.setAttribute('data-overflow', needsScroll.toString());
                        
                        // Adjust appearance based on need for scrollbar
                        if (needsScroll) {
                            scrollContainer.style.overflowX = 'auto';
                        } else {
                            scrollContainer.style.overflowX = 'hidden';
                        }
                    }
                }
                
                // Call function on load and resize
                checkTimelineOverflow();
                window.addEventListener('resize', checkTimelineOverflow);
                
                // Fetch appointments for timeline by date
                async function fetchAppointmentsForTimeline(date) {
                    try {
                        // Show loading indicator
                        const timelineGrid = document.getElementById('timelineGrid');
                        const loadingIndicator = document.getElementById('timelineLoading');
                        
                        if (timelineGrid && loadingIndicator) {
                            timelineGrid.innerHTML = '';
                            timelineGrid.appendChild(loadingIndicator);
                            loadingIndicator.style.display = 'block';
                        }
                        
                        // Create API URL with date parameter
                        const apiUrl = `/api/appointments/timeline?date=${date}`;
                        
                        // Fetch appointments from the database
                        const response = await fetch(apiUrl);
                        
                        // Check if the request was successful
                        if (!response.ok) {
                            console.warn(`API endpoint not available (${response.status}). Using fallback data.`);
                            // Return hardcoded data as fallback
                            const fallbackData = {
                                doctors: [
                                    {
                                        id: 1,
                                        name: 'Dr. Chua Tsun Ting',
                                        appointments: [
                                            { 
                                                id: 1,
                                                patientName: 'John Smith', 
                                                startTime: `${date}T10:00:00`, 
                                                duration: 60, 
                                                type: 'General Consultation' 
                                            },
                                            { 
                                                id: 2,
                                                patientName: 'Mary Johnson', 
                                                startTime: `${date}T12:30:00`, 
                                                duration: 30, 
                                                type: 'Follow-up' 
                                            }
                                        ]
                                    },
                                    {
                                        id: 2,
                                        name: 'Dr. Lee Lap Him',
                                        appointments: [
                                            { 
                                                id: 3,
                                                patientName: 'David Wong', 
                                                startTime: `${date}T13:00:00`, 
                                                duration: 45, 
                                                type: 'Emergency' 
                                            }
                                        ]
                                    }
                                ]
                            };
                            
                            // Hide loading indicator
                            if (loadingIndicator) {
                                loadingIndicator.style.display = 'none';
                            }
                            
                            return fallbackData;
                        }
                        
                        const data = await response.json();
                        
                        // Hide loading indicator
                        if (loadingIndicator) {
                            loadingIndicator.style.display = 'none';
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Error fetching appointments:', error);
                        
                        // Return hardcoded data as fallback in case of errors
                        const fallbackData = {
                            doctors: [
                                {
                                    id: 1,
                                    name: 'Dr. Chua Tsun Ting',
                                    appointments: [
                                        { 
                                            id: 1,
                                            patientName: 'John Smith', 
                                            startTime: `${date}T10:00:00`, 
                                            duration: 60, 
                                            type: 'General Consultation' 
                                        },
                                        { 
                                            id: 2,
                                            patientName: 'Mary Johnson', 
                                            startTime: `${date}T12:30:00`, 
                                            duration: 30, 
                                            type: 'Follow-up' 
                                        }
                                    ]
                                },
                                {
                                    id: 2,
                                    name: 'Dr. Lee Lap Him',
                                    appointments: [
                                        { 
                                            id: 3,
                                            patientName: 'David Wong', 
                                            startTime: `${date}T13:00:00`, 
                                            duration: 45, 
                                            type: 'Emergency' 
                                        }
                                    ]
                                }
                            ]
                        };
                        
                        // Hide loading indicator
                        const loadingIndicator = document.getElementById('timelineLoading');
                        if (loadingIndicator) {
                            loadingIndicator.style.display = 'none';
                        }
                        
                        return fallbackData;
                    }
                }
                
                // Function to calculate position based on time
                function calculatePosition(time) {
                    // Extract hours and minutes from datetime string
                    const timePart = time.split('T')[1];
                    const [hours, minutes] = timePart.split(':').map(Number);
                    
                    // Calculate slot position based on time
                    return ((hours - workStartHour) * 2 + (minutes >= 30 ? 1 : 0)) * slotWidth;
                }
                
                // Function to determine appointment color
                function getAppointmentClass(type) {
                    switch(type) {
                        case 'Emergency':
                            return 'red';
                        case 'Follow-up':
                            return 'teal';
                        default:
                            return '';
                    }
                }
                
                // Position appointments on timeline
                async function updateTimeline(date) {
                    // Get data
                    const data = await fetchAppointmentsForTimeline(date);
                    
                    // Get timeline grid and empty it
                    const timelineGrid = document.getElementById('timelineGrid');
                    if (!timelineGrid) return;
                    
                    timelineGrid.innerHTML = '';
                    
                    // If no doctors or appointments, show message
                    if (!data.doctors || data.doctors.length === 0) {
                        const noDataMessage = document.createElement('div');
                        noDataMessage.className = 'no-data-message';
                        noDataMessage.textContent = 'No appointments found for this date.';
                        timelineGrid.appendChild(noDataMessage);
                        return;
                    }
                    
                    // For each doctor
                    data.doctors.forEach(doctor => {
                        // Create doctor row
                        const doctorRow = document.createElement('div');
                        doctorRow.className = 'doctor-row';
                        
                        // Create doctor column
                        const doctorColumn = document.createElement('div');
                        doctorColumn.className = 'doctor-column';
                        doctorColumn.textContent = doctor.name;
                        
                        // Create timeline slots
                        const timelineSlots = document.createElement('div');
                        timelineSlots.className = 'timeline-slots';
                        
                        // Add appointments
                        if (doctor.appointments && doctor.appointments.length > 0) {
                            doctor.appointments.forEach(appointment => {
                                const leftPosition = calculatePosition(appointment.startTime);
                                const width = (appointment.duration / 30) * slotWidth - 10; // Subtract margin
                                
                                const appointmentBlock = document.createElement('div');
                                appointmentBlock.className = `appointment-block ${getAppointmentClass(appointment.type)}`;
                                appointmentBlock.style.left = `${leftPosition}px`;
                                appointmentBlock.style.width = `${width}px`;
                                appointmentBlock.textContent = appointment.patientName;
                                appointmentBlock.dataset.appointmentId = appointment.id;
                                
                                // Add click event
                                appointmentBlock.addEventListener('click', function() {
                                    // This would be replaced with a proper detail view
                                    alert(`Appointment details for ${appointment.patientName}\nType: ${appointment.type}\nTime: ${appointment.startTime.split('T')[1].substring(0, 5)}\nDuration: ${appointment.duration} mins`);
                                });
                                
                                timelineSlots.appendChild(appointmentBlock);
                            });
                        }
                        
                        // Assemble row
                        doctorRow.appendChild(doctorColumn);
                        doctorRow.appendChild(timelineSlots);
                        
                        // Add to grid
                        timelineGrid.appendChild(doctorRow);
                    });
                    
                    // After adding all appointments, check for overflow again
                    checkTimelineOverflow();
                }
                
                // Handle window resize
                window.addEventListener('resize', function() {
                    // Recalculate dimensions on resize
                    checkTimelineOverflow();
                });
                
                // Force proper overflow settings on all parent containers
                document.querySelectorAll('html, body, .main-content, .content-container, .timeline-container').forEach(el => {
                    if (el) {
                        el.style.overflowX = 'hidden';
                        el.style.maxWidth = '100%';
                    }
                });
                
                // Make sure only the scroll container has horizontal scrolling
                const scrollContainer = document.querySelector('.timeline-scroll-container');
                if (scrollContainer) {
                    scrollContainer.style.overflowX = 'auto';
                }
                
                // Pending Appointments Table
                
                // Set default date range to current day only
                function setDefaultDateRange() {
                    const today = new Date();
                    const formattedDate = getTodayFormatted();
                    
                    document.getElementById('startDate').value = formattedDate;
                    document.getElementById('endDate').value = formattedDate;
                }
                
                // Format date for display with localized time
                function formatDate(dateString) {
                    const date = new Date(dateString);
                    
                    // Format year, month, day
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    
                    // Get time of day (AM/PM) in local language
                    const timeOfDay = date.getHours() < 12 ? 'am' : 'pm';
                    
                    // Format hours and minutes in 12-hour format
                    let hours = date.getHours() % 12;
                    hours = hours === 0 ? 12 : hours; // Convert 0 to 12 for 12 AM
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    
                    return `${year}-${month}-${day} ${timeOfDay} ${hours}:${minutes}`;
                }
                
                // Fetch pending appointments for date range
                async function fetchPendingAppointments(startDate, endDate) {
                    try {
                        // Create formatted date strings for API
                        const formattedStartDate = startDate + 'T00:00:00';
                        const formattedEndDate = endDate + 'T23:59:59';
                        
                        // Create API URL with date range parameters
                        const apiUrl = `/api/appointments/pending?startDate=${formattedStartDate}&endDate=${formattedEndDate}`;
                        
                        // Fetch pending appointments from the database
                        const response = await fetch(apiUrl);
                        
                        // Check if the request was successful
                        if (!response.ok) {
                            console.warn(`API endpoint not available (${response.status}). Using fallback data.`);
                            // Return hardcoded data as fallback
                            return [
                                {
                                    id: 1,
                                    patientName: 'John Smith',
                                    doctor: 'Dr. Chua Tsun Ting',
                                    appointmentType: 'General Consultation',
                                    scheduledTime: '2023-05-10T10:00:00',
                                    duration: 60,
                                    priority: 'Medium',
                                    status: 'Pending'
                                },
                                {
                                    id: 2,
                                    patientName: 'Mary Johnson',
                                    doctor: 'Dr. Chua Tsun Ting',
                                    appointmentType: 'Follow-up',
                                    scheduledTime: '2023-05-10T12:30:00',
                                    duration: 30,
                                    priority: 'Low',
                                    status: 'Pending'
                                },
                                {
                                    id: 3,
                                    patientName: 'David Wong',
                                    doctor: 'Dr. Lee Lap Him',
                                    appointmentType: 'Emergency',
                                    scheduledTime: '2023-05-10T13:00:00',
                                    duration: 45,
                                    priority: 'High',
                                    status: 'Pending'
                                }
                            ];
                        }
                        
                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error('Error fetching pending appointments:', error);
                        // Return hardcoded data as fallback
                        return [
                            {
                                id: 1,
                                patientName: 'John Smith',
                                doctor: 'Dr. Chua Tsun Ting',
                                appointmentType: 'General Consultation',
                                scheduledTime: '2023-05-10T10:00:00',
                                duration: 60,
                                priority: 'Medium',
                                status: 'Pending'
                            },
                            {
                                id: 2,
                                patientName: 'Mary Johnson',
                                doctor: 'Dr. Chua Tsun Ting',
                                appointmentType: 'Follow-up',
                                scheduledTime: '2023-05-10T12:30:00',
                                duration: 30,
                                priority: 'Low',
                                status: 'Pending'
                            },
                            {
                                id: 3,
                                patientName: 'David Wong',
                                doctor: 'Dr. Lee Lap Him',
                                appointmentType: 'Emergency',
                                scheduledTime: '2023-05-10T13:00:00',
                                duration: 45,
                                priority: 'High',
                                status: 'Pending'
                            }
                        ];
                    }
                }
                
                // Render pending appointments table
                async function renderPendingAppointmentsTable(startDate, endDate) {
                    const tableBody = document.getElementById('pendingAppointmentsList');
                    if (!tableBody) return;
                    
                    // Show loading message
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <p>Loading pending appointments...</p>
                            </td>
                        </tr>
                    `;
                    
                    // Fetch appointments
                    const appointments = await fetchPendingAppointments(startDate, endDate);
                    
                    if (appointments.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <p>No pending appointments found for the selected date range.</p>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Build table rows
                    let html = '';
                    appointments.forEach(appointment => {
                        // Create priority badge class
                        let priorityClass = 'status-badge';
                        if (appointment.priority === 'High') {
                            priorityClass += ' red';
                        } else if (appointment.priority === 'Medium') {
                            priorityClass += '';
                        } else {
                            priorityClass += ' teal';
                        }
                        
                        html += `
                            <tr>
                                <td>${appointment.patientName}</td>
                                <td>${appointment.doctor}</td>
                                <td>${appointment.appointmentType}</td>
                                <td>${formatDate(appointment.scheduledTime)}</td>
                                <td>${appointment.duration} mins</td>
                                <td><span class="${priorityClass}">${appointment.priority}</span></td>
                                <td><span class="status-badge">${appointment.status}</span></td>
                                <td>
                                    <div class="patient-actions">
                                        <a href="/appointment/edit/${appointment.id}" title="Edit">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M17 3C17.2626 2.73735 17.5744 2.52901 17.9176 2.38687C18.2608 2.24473 18.6286 2.17157 19 2.17157C19.3714 2.17157 19.7392 2.24473 20.0824 2.38687C20.4256 2.52901 20.7374 2.73735 21 3C21.2626 3.26264 21.471 3.57444 21.6131 3.9176C21.7553 4.26077 21.8284 4.62856 21.8284 5C21.8284 5.37143 21.7553 5.73923 21.6131 6.08239C21.471 6.42555 21.2626 6.73735 21 7L7.5 20.5L2 22L3.5 16.5L17 3Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </a>
                                        <a href="/appointment/cancel/${appointment.id}" title="Cancel" onclick="return confirm('Are you sure you want to cancel this appointment?');">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M3 6H5H21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </a>
                                        <a href="/appointment/complete/${appointment.id}" title="Mark as Complete">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M20 6L9 17L4 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = html;
                    
                    // Ensure any parent containers don't restrict expansion
                    let parent = document.getElementById('pendingAppointmentsTable');
                    while (parent) {
                        if (parent.style) {
                            parent.style.overflow = 'visible';
                            parent.style.maxHeight = 'none';
                        }
                        parent = parent.parentElement;
                    }
                }
                
                // Set up date range controls
                function initializeDateRangeControls() {
                    setDefaultDateRange();
                    
                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');
                    
                    if (startDateInput && endDateInput) {
                        // Initial load of appointments
                        renderPendingAppointmentsTable(startDateInput.value, endDateInput.value);
                        
                        // Auto-fetch data when start date loses focus
                        startDateInput.addEventListener('blur', function() {
                            // Only fetch if both dates are valid
                            if (startDateInput.value && endDateInput.value) {
                                // Verify end date is not before start date
                                if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
                                    endDateInput.value = startDateInput.value;
                                }
                                renderPendingAppointmentsTable(startDateInput.value, endDateInput.value);
                            }
                        });
                        
                        // Auto-fetch data when end date loses focus
                        endDateInput.addEventListener('blur', function() {
                            // Only fetch if both dates are valid
                            if (startDateInput.value && endDateInput.value) {
                                // Verify end date is not before start date
                                if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
                                    alert('End date cannot be earlier than start date');
                                    endDateInput.value = startDateInput.value;
                                }
                                renderPendingAppointmentsTable(startDateInput.value, endDateInput.value);
                            }
                        });
                        
                        // Also handle the change event for browser date pickers that might not trigger blur
                        startDateInput.addEventListener('change', function() {
                            if (startDateInput.value && endDateInput.value) {
                                // Small delay to ensure the change is complete
                                setTimeout(() => {
                                    if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
                                        endDateInput.value = startDateInput.value;
                                    }
                                    renderPendingAppointmentsTable(startDateInput.value, endDateInput.value);
                                }, 100);
                            }
                        });
                        
                        endDateInput.addEventListener('change', function() {
                            if (startDateInput.value && endDateInput.value) {
                                // Small delay to ensure the change is complete
                                setTimeout(() => {
                                    if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
                                        alert('End date cannot be earlier than start date');
                                        endDateInput.value = startDateInput.value;
                                    }
                                    renderPendingAppointmentsTable(startDateInput.value, endDateInput.value);
                                }, 100);
                            }
                        });
                    }
                }
                
                // Initialize pending appointments section
                initializeDateRangeControls();
                
                // Make sure content card for Pending Appointments expands properly
                document.querySelectorAll('.content-card, .pending-appointments-container, .pending-appointments-table').forEach(el => {
                    if (el) {
                        el.style.overflow = 'visible';
                        el.style.maxWidth = '100%';
                        el.style.minWidth = '100%';
                        el.style.width = '100%';
                        el.style.maxHeight = 'none';
                        el.style.height = 'auto';
                    }
                });
                
                // Remove any inner scrollbars in the timeline
                if (timelineContent) {
                    timelineContent.style.overflow = 'visible';
                }
                
                // Ensure only the timeline-scroll-container has a horizontal scrollbar
                const timelineScrollContainer = document.querySelector('.timeline-scroll-container');
                if (timelineScrollContainer) {
                    timelineScrollContainer.style.overflowX = 'auto';
                    timelineScrollContainer.style.overflowY = 'hidden';
                }

                // Fix all other containers to prevent scrollbars
                document.querySelectorAll('.timeline-container, .content-container, main, body, html').forEach(el => {
                    if (el && el !== timelineScrollContainer) {
                        el.style.overflowX = 'hidden';
                    }
                });
                
                // Make sure the entire page content expands properly
                document.querySelectorAll('.content-container').forEach(el => {
                    if (el) {
                        el.style.overflow = 'hidden';
                        el.style.display = 'flex';
                        el.style.flexDirection = 'column';
                        el.style.width = '100%';
                    }
                });
                
                // Ensure pending appointments section expands fully
                const pendingAppointmentsSection = document.querySelector('.content-card');
                if (pendingAppointmentsSection) {
                    pendingAppointmentsSection.style.width = '100%';
                    pendingAppointmentsSection.style.overflow = 'visible';
                    pendingAppointmentsSection.style.maxHeight = 'none';
                    pendingAppointmentsSection.style.height = 'auto';
                    
                    // Force reflow to ensure proper expansion
                    pendingAppointmentsSection.offsetHeight;
                }
            });
        </script>
        
        <style>
            /* Content card and table styles based on patient-list.html */
            .content-card {
                background-color: var(--secondary-bg);
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                width: 100%;
                box-sizing: border-box;
                overflow: visible !important;
                min-width: 100%; /* Ensure it's at least 100% wide */
                max-width: 100%; /* Don't exceed container width */
                height: auto !important; /* Allow height to grow naturally */
                min-height: 0; /* Remove min-height constraints */
                max-height: none !important; /* No maximum height */
                margin-top: 2rem;
                margin-bottom: 0;
            }
            
            .d-flex {
                display: flex;
            }
            
            .justify-content-between {
                justify-content: space-between;
            }
            
            .align-items-center {
                align-items: center;
            }
            
            .mb-4 {
                margin-bottom: 1.5rem;
            }
            
            .py-4 {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            
            .text-center {
                text-align: center;
            }
            
            h2 {
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0;
                color: var(--primary-text);
            }
            
            /* Specific styles for pending appointments */
            .pending-appointments-container {
                overflow: visible !important;
                width: 100%;
                margin: 0;
                padding: 0;
                min-width: 100%;
                max-width: 100%;
                height: auto !important;
                min-height: 0;
                max-height: none !important;
            }
            
            .pending-appointments-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
                height: auto !important;
                min-height: 0;
                max-height: none !important;
            }
            
            .pending-appointments-table th,
            .pending-appointments-table td {
                padding: 12px 15px;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
                white-space: normal;
                word-wrap: break-word;
            }
            
            .pending-appointments-table th {
                font-weight: 600;
                color: var(--accent-color);
                text-align: left;
            }
            
            .pending-appointments-table tr:hover {
                background-color: rgba(138, 43, 226, 0.05);
            }
            
            .status-badge {
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 1rem;
                font-size: 0.75rem;
                font-weight: 600;
                background-color: rgba(138, 43, 226, 0.1);
                color: #8a2be2;
            }
            
            .status-badge.red {
                background-color: rgba(239, 68, 68, 0.1);
                color: #ef4444;
            }
            
            .status-badge.teal {
                background-color: rgba(20, 184, 166, 0.1);
                color: #14b8a6;
            }
            
            .patient-actions {
                display: flex;
                gap: 8px;
            }
            
            .patient-actions a {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 28px;
                height: 28px;
                border-radius: 4px;
                background-color: rgba(138, 43, 226, 0.1);
                transition: background-color 0.2s;
            }
            
            .patient-actions a:hover {
                background-color: rgba(138, 43, 226, 0.2);
            }
            
            /* Date range selector styles */
            .date-range-selector {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.9rem;
            }
            
            .date-input {
                padding: 6px 12px;
                border-radius: 4px;
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--primary-text);
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 8px center;
                background-size: 16px;
                padding-right: 32px;
            }
            
            .btn-sm {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            .btn-primary {
                background-color: var(--accent-color);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            
            .btn-primary:hover {
                background-color: #7b26cd;
            }

            /* Fix for calendar icon in date inputs */
            .date-input {
                padding: 6px 12px;
                border-radius: 4px;
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--primary-text);
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 8px center;
                background-size: 16px;
                padding-right: 32px;
                /* Remove the browser's default calendar icon */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }

            /* Date selector for timeline */
            .date-selector {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.9rem;
                margin-right: 20px;
            }

            /* Loading indicator */
            .loading-indicator {
                text-align: center;
                padding: 1rem;
                color: var(--secondary-text);
            }
        </style>
    </th:block>
</body>
</html> 