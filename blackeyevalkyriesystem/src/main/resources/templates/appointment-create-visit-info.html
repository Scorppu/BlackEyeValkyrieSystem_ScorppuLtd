<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Appointment - BlackEyeValkyrieSystem</title>
    
    <th:block layout:fragment="head">
        <!-- Visit Information specific CSS -->
        <style>
            .form-card {
                background-color: var(--secondary-bg);
                border-radius: 0.75rem;
                padding: 2rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            
            /* Container constraints */
            .content-container {
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            body {
                overflow-x: hidden;
            }
            
            .form-section {
                margin-bottom: 2rem;
                width: 100%;
                max-width: 100%;
                overflow: hidden;
            }
            
            .form-section-header {
                margin-bottom: 1.5rem;
            }
            
            .form-section-header h2 {
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0;
                color: var(--primary-text);
            }
            
            .form-section-header p {
                font-size: 0.875rem;
                color: var(--secondary-text);
                margin: 0.5rem 0 0;
            }
            
            .form-row {
                margin-bottom: 1.5rem;
            }
            
            .form-group {
                position: relative;
                margin-bottom: 1.5rem;
            }
            
            .form-label {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.875rem;
                font-weight: 500;
                color: var(--secondary-text);
                margin-bottom: 0.5rem;
            }
            
            .form-label svg {
                width: 1rem;
                height: 1rem;
                color: var(--secondary-text);
            }
            
            .form-control {
                width: 100%;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--primary-text);
                font-size: 1rem;
                transition: border-color 0.2s, box-shadow 0.2s;
            }
            
            .form-select {
                width: 100%;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--primary-text);
                font-size: 1rem;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M4 6L8 10L12 6' stroke='%236B7280' stroke-width='1.33333' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 1rem center;
                transition: border-color 0.2s, box-shadow 0.2s;
            }
            
            .form-control:focus, .form-select:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.3);
            }
            
            .form-control:disabled, .form-select:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }
            
            .input-group {
                display: flex;
                width: 100%;
            }
            
            .input-group .form-control {
                flex: 1;
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
            }
            
            .input-group-text {
                display: flex;
                align-items: center;
                padding: 0.75rem 1rem;
                background-color: var(--secondary-bg);
                border: 1px solid var(--border-color);
                border-left: none;
                border-top-right-radius: 0.5rem;
                border-bottom-right-radius: 0.5rem;
                color: var(--secondary-text);
                font-size: 1rem;
            }
            
            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
                text-decoration: none;
                border: none;
            }
            
            .btn-primary {
                background-color: var(--accent-color);
                color: white;
            }
            
            .btn-primary:hover {
                background-color: #7b26cd;
            }
            
            .select-wrapper {
                position: relative;
            }
            
            .doctor-search {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1;
                background: transparent;
                border: none;
                padding: 0.375rem 0.75rem;
                color: transparent;
            }
            
            .doctor-search:focus {
                outline: none;
                box-shadow: none;
            }
            
            #doctorName {
                position: relative;
                z-index: 2;
                background: white;
            }
            
            /* Timeline styles */
            .timeline-container {
                background-color: var(--secondary-bg);
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-top: 1rem;
                margin-bottom: 1.5rem;
                display: none; /* Hidden by default */
                width: 100%;
                box-sizing: border-box;
                overflow: hidden; /* Prevent container overflow */
                max-width: 100%;
            }
            
            .timeline-scroll-container {
                overflow-x: auto;
                scrollbar-width: thin;
                scrollbar-color: var(--accent-color) rgba(138, 43, 226, 0.1);
                padding-bottom: 8px;
                width: 100%;
                max-width: 100%;
            }
            
            .timeline-content {
                width: 1700px;
                max-width: none; /* Allow content to be wider than container for scrolling */
                position: relative;
            }
            
            /* Scrollbar styling for webkit browsers */
            .timeline-scroll-container::-webkit-scrollbar {
                height: 8px;
            }
            
            .timeline-scroll-container::-webkit-scrollbar-track {
                background: rgba(138, 43, 226, 0.1);
                border-radius: 4px;
            }
            
            .timeline-scroll-container::-webkit-scrollbar-thumb {
                background-color: var(--accent-color);
                border-radius: 4px;
            }
            
            .timeline-header {
                display: flex;
                margin-bottom: 1rem;
                width: 100%;
            }
            
            .timeline-header h3 {
                margin: 0;
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--primary-text);
                width: 120px;
                min-width: 120px;
                flex-shrink: 0;
                padding-left: 1rem;
            }
            
            .timeline-grid {
                display: flex;
                width: 100%;
                position: relative;
            }
            
            .timeline-grid .doctor-column {
                padding: 1rem;
                background-color: var(--secondary-bg);
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                font-weight: 500;
                width: 120px;
                min-width: 120px;
                flex-shrink: 0;
            }
            
            .timeline-times {
                display: flex;
                flex-grow: 1;
                max-width: calc(100% - 120px);
            }
            
            .timeline-time {
                text-align: center;
                font-size: 0.875rem;
                font-weight: 500;
                padding: 0.5rem;
                width: 100px;
                min-width: 100px;
                flex-shrink: 0;
            }
            
            .timeline-slots {
                display: flex;
                flex-grow: 1;
                position: relative;
                height: 80px;
                max-width: calc(100% - 120px);
            }
            
            .appointment-block {
                background-color: rgba(138, 43, 226, 0.2);
                border-left: 4px solid #8a2be2;
                border-radius: 0.375rem;
                padding: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.875rem;
                height: 80%;
                margin: auto 5px;
                position: absolute;
                top: 10%;
                min-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                box-sizing: border-box;
                z-index: 1;
            }
            
            .appointment-block.teal {
                background-color: rgba(20, 184, 166, 0.2);
                border-left-color: #14b8a6;
            }
            
            .appointment-block.red {
                background-color: rgba(239, 68, 68, 0.2);
                border-left-color: #ef4444;
            }
            
            .appointment-block.dotted {
                border: 2px dashed #8a2be2;
                background-color: rgba(138, 43, 226, 0.1);
                border-left: 4px solid #8a2be2;
            }
            
            /* Loading indicator */
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(138, 43, 226, 0.3);
                border-radius: 50%;
                border-top-color: var(--accent-color);
                animation: spin 1s ease-in-out infinite;
                margin-left: 10px;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            /* Form element constraints */
            .form-row, 
            .form-group, 
            .form-control, 
            .form-select,
            #visitInfoForm {
                max-width: 100%;
                box-sizing: border-box;
                position: relative;
            }
            
            /* Ensure header and timeline containers don't exceed width */
            .header, 
            .header-actions,
            .timeline-container, 
            .form-card,
            .form-section {
                max-width: 100%;
                box-sizing: border-box;
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="custom-header">
        <header class="header">
            <h1>Create Appointment</h1>
            <div class="header-actions">
                <button type="submit" form="visitInfoForm" class="btn btn-primary">Confirm</button>
            </div>
        </header>
    </div>
    
    <div layout:fragment="content">
        <div class="content-container">
            <div class="form-card">
                <div class="form-section">
                    <div class="form-section-header">
                        <h2>Visit Information</h2>
                        <p>Please insert patient's Visit information</p>
                    </div>
                    
                    <form id="visitInfoForm" th:action="@{/appointment/create/visit-info}" method="post">
                        <input type="hidden" name="patientId" th:value="${patient.id}">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="appointmentType">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12.6667 3.33334H3.33333C2.59695 3.33334 2 3.93029 2 4.66668V12.6667C2 13.403 2.59695 14 3.33333 14H12.6667C13.403 14 14 13.403 14 12.6667V4.66668C14 3.93029 13.403 3.33334 12.6667 3.33334Z" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M10.6667 2V4.66667" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M5.33334 2V4.66667" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M2 7.33334H14" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M7.33334 10H8.00001" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M8 10V11.3333" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Appointment Type
                                </label>
                                <select class="form-select" id="appointmentType" name="appointmentType" required>
                                    <option th:each="type : ${appointmentTypes}" th:value="${type}" th:text="${type}" th:selected="${type == 'General Consultation'}"></option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="requiredTime">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M8 4.66667V8.00001L10 10" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Required Time
                                </label>
                                <div class="input-group">
                                    <input class="form-control" type="number" id="requiredTime" name="requiredTime" value="30" min="1" required>
                                    <span class="input-group-text">minutes</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="appointmentPriority">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M7.33334 13.3333C10.647 13.3333 13.3333 10.647 13.3333 7.33333C13.3333 4.01967 10.647 1.33333 7.33334 1.33333C4.01967 1.33333 1.33334 4.01967 1.33334 7.33333C1.33334 10.647 4.01967 13.3333 7.33334 13.3333Z" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M14 14L11.6667 11.6667" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Appointment Priority
                                </label>
                                <select class="form-select" id="appointmentPriority" name="appointmentPriority" required>
                                    <option th:each="priority : ${appointmentPriorities}" th:value="${priority}" th:text="${priority}" th:selected="${priority == 'low'}"></option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="doctorName">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 10C10.2091 10 12 8.20914 12 6C12 3.79086 10.2091 2 8 2C5.79086 2 4 3.79086 4 6C4 8.20914 5.79086 10 8 10Z" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M14 14C12.5164 12.5085 10.3249 11.6667 8.00008 11.6667C5.67523 11.6667 3.48328 12.5097 2 14" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Doctor Name
                                </label>
                                <div class="select-wrapper">
                                    <select class="form-select" id="doctorName" name="doctorName">
                                        <option value="">Select a doctor</option>
                                        <option th:each="doctor : ${doctors}" 
                                                th:value="${doctor.firstName + ' ' + doctor.lastName}"
                                                th:text="${doctor.firstName + ' ' + doctor.lastName + ' - ' + doctor.specialization}">
                                        </option>
                                    </select>
                                    <input type="text" class="form-control doctor-search" placeholder="Search doctor...">
                                </div>
                                <div id="doctorLoading" class="loading" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <!-- Doctor timeline container - will be shown when a doctor is selected -->
                        <div id="timelineContainer" class="timeline-container">
                            <div class="timeline-scroll-container">
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <h3>Doctor's Schedule</h3>
                                        <div class="timeline-times" id="timelineHeader">
                                            <!-- Time slots will be dynamically generated -->
                                        </div>
                                    </div>
                                    
                                    <div class="timeline-grid">
                                        <div class="doctor-column" id="doctorColumn">
                                            <!-- Doctor name will be inserted here -->
                                        </div>
                                        <div class="timeline-slots" id="timelineSlots">
                                            <!-- Appointment blocks will be dynamically generated -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="scheduledTime">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M8 4.66667V8.00001L10 10" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Scheduled Time
                                </label>
                                <input class="form-control" type="datetime-local" id="scheduledTime" name="scheduledTime" disabled>
                                <p id="scheduledTimeHelp" class="form-text" style="font-size: 0.8rem; color: var(--secondary-text); margin-top: 0.5rem;">
                                    Select a doctor first to see available time slots
                                </p>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="notes">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M7.33333 2H2.66667C2.29848 2 2 2.29848 2 2.66667V13.3333C2 13.7015 2.29848 14 2.66667 14H13.3333C13.7015 14 14 13.7015 14 13.3333V8.66667" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12.6667 2.33333C13.0349 1.96514 13.6334 1.96514 14.0016 2.33333C14.3698 2.70152 14.3698 3.30009 14.0016 3.66828L8.33329 9.33333L6.33331 10L6.99995 8L12.6667 2.33333Z" stroke="currentColor" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Notes
                                </label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Add any additional notes about this appointment"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Visit information page loaded');
                
                const doctorSelect = document.getElementById('doctorName');
                const doctorSearch = document.querySelector('.doctor-search');
                const requiredTimeInput = document.getElementById('requiredTime');
                const scheduledTimeInput = document.getElementById('scheduledTime');
                const scheduledTimeHelp = document.getElementById('scheduledTimeHelp');
                const timelineContainer = document.getElementById('timelineContainer');
                const timelineHeader = document.getElementById('timelineHeader');
                const doctorColumn = document.getElementById('doctorColumn');
                const timelineSlots = document.getElementById('timelineSlots');
                const doctorLoading = document.getElementById('doctorLoading');
                
                // Initialize date fields
                const now = new Date();
                const minDateTime = new Date(now.getTime() + 30 * 60000); // 30 minutes from now
                
                // Format to YYYY-MM-DDThh:mm
                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                };
                
                // Parse a datetime string into a Date object
                const parseDateTime = (dateTimeStr) => {
                    return new Date(dateTimeStr);
                };
                
                // Format a date for display
                const formatTimeDisplay = (date) => {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                };
                
                // Handle doctor search
                if (doctorSearch && doctorSelect) {
                    doctorSearch.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const options = doctorSelect.options;
                        
                        for (let i = 0; i < options.length; i++) {
                            const option = options[i];
                            const text = option.text.toLowerCase();
                            
                            if (text.includes(searchTerm)) {
                                option.style.display = '';
                                if (i === doctorSelect.selectedIndex) {
                                    doctorSearch.value = option.text;
                                }
                            } else {
                                option.style.display = 'none';
                            }
                        }
                    });
                    
                    doctorSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption) {
                            doctorSearch.value = selectedOption.text;
                            
                            // When a doctor is selected, load their schedule
                            if (selectedOption.value) {
                                fetchDoctorSchedule(selectedOption.value);
                            } else {
                                // If no doctor selected, hide timeline and disable scheduledTime
                                timelineContainer.style.display = 'none';
                                scheduledTimeInput.disabled = true;
                                scheduledTimeInput.value = '';
                                scheduledTimeHelp.textContent = 'Select a doctor first to see available time slots';
                            }
                        }
                    });
                }
                
                // When required time changes, update the timeline if a doctor is selected
                requiredTimeInput.addEventListener('change', function() {
                    const doctorName = doctorSelect.value;
                    if (doctorName) {
                        fetchDoctorSchedule(doctorName);
                    }
                });
                
                function fetchDoctorSchedule(doctorName) {
                    // Show loading indicator
                    doctorLoading.style.display = 'inline-block';
                    
                    // Get today's date at 00:00
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Get end of today (23:59:59)
                    const endOfToday = new Date(today);
                    endOfToday.setHours(23, 59, 59, 999);
                    
                    // Format dates for API
                    const startTime = today.toISOString();
                    const endTime = endOfToday.toISOString();
                    
                    // Fetch doctor's appointments for today
                    fetch(`/api/appointments/doctor/${encodeURIComponent(doctorName)}/daterange?startTime=${startTime}&endTime=${endTime}`)
                        .then(response => response.json())
                        .then(appointments => {
                            // Find the next available time slot
                            const requiredTime = parseInt(requiredTimeInput.value, 10);
                            fetch(`/api/appointments/doctor/${encodeURIComponent(doctorName)}/next-available?requiredTime=${requiredTime}`)
                                .then(response => response.json())
                                .then(data => {
                                    // Update the scheduled time input with the next available time
                                    const nextAvailableTime = data.nextAvailableTime;
                                    scheduledTimeInput.value = nextAvailableTime.replace('T', ' ').substring(0, 16).replace(' ', 'T');
                                    scheduledTimeInput.disabled = false;
                                    scheduledTimeHelp.textContent = 'Suggested time based on doctor\'s availability';
                                    
                                    // Display the timeline
                                    displayTimeline(doctorName, appointments, nextAvailableTime, requiredTime);
                                    
                                    // Hide loading indicator
                                    doctorLoading.style.display = 'none';
                                })
                                .catch(error => {
                                    console.error('Error fetching next available time:', error);
                                    scheduledTimeInput.disabled = false;
                                    scheduledTimeHelp.textContent = 'Error fetching schedule. Please select a time manually.';
                                    doctorLoading.style.display = 'none';
                                });
                        })
                        .catch(error => {
                            console.error('Error fetching appointments:', error);
                            timelineContainer.style.display = 'none';
                            scheduledTimeInput.disabled = false;
                            scheduledTimeHelp.textContent = 'Error fetching schedule. Please select a time manually.';
                            doctorLoading.style.display = 'none';
                        });
                }
                
                function displayTimeline(doctorName, appointments, nextAvailableTime, requiredTime) {
                    // Clear previous timeline
                    timelineHeader.innerHTML = '';
                    timelineSlots.innerHTML = '';
                    doctorColumn.textContent = doctorName;
                    
                    // Show timeline container
                    timelineContainer.style.display = 'block';
                    
                    // Appointment working hours: 9 AM to 5 PM
                    const workStartHour = 9;
                    const workEndHour = 17;
                    
                    // Generate time slots (every 30 minutes) in a single row
                    for (let hour = workStartHour; hour <= workEndHour; hour++) {
                        for (let minute = 0; minute < 60; minute += 30) {
                            if (hour === workEndHour && minute > 0) continue; // Skip after 5 PM
                            
                            const displayTime = `${hour}:${minute === 0 ? '00' : minute}`;
                            const timeSlot = document.createElement('div');
                            timeSlot.className = 'timeline-time';
                            timeSlot.textContent = displayTime;
                            timelineHeader.appendChild(timeSlot);
                        }
                    }
                    
                    // Sort appointments by scheduled time
                    appointments.sort((a, b) => new Date(a.scheduledTime) - new Date(b.scheduledTime));
                    
                    // Calculate total time slots
                    const timeSlots = (workEndHour - workStartHour) * 2 + 1; // 30-minute slots
                    let timelineItems = Array(timeSlots).fill(null);
                    
                    // Slot width in pixels
                    const slotWidth = 100;
                    
                    // Place existing appointments in the timeline
                    appointments.forEach(appointment => {
                        const startTime = new Date(appointment.scheduledTime);
                        const endTime = new Date(startTime.getTime() + appointment.requiredTime * 60000);
                        
                        // Skip appointments outside working hours
                        if (startTime.getHours() < workStartHour || startTime.getHours() >= workEndHour) {
                            return;
                        }
                        
                        // Calculate position
                        const startSlot = (startTime.getHours() - workStartHour) * 2 + (startTime.getMinutes() >= 30 ? 1 : 0);
                        const durationSlots = Math.ceil(appointment.requiredTime / 30);
                        
                        // Create appointment block
                        const appointmentBlock = document.createElement('div');
                        appointmentBlock.className = 'appointment-block';
                        
                        // Position the block using absolute positioning
                        appointmentBlock.style.left = `${startSlot * slotWidth}px`;
                        appointmentBlock.style.width = `${durationSlots * slotWidth - 10}px`; // -10 for margins
                        
                        // Add patient name or appointment type
                        appointmentBlock.textContent = appointment.patient ? 
                            `${appointment.patient.firstName} ${appointment.patient.lastName}` : 
                            appointment.appointmentType;
                        
                        // Add appointment to the slots container
                        timelineSlots.appendChild(appointmentBlock);
                        
                        // Mark slots as occupied
                        for (let i = 0; i < durationSlots; i++) {
                            if (startSlot + i < timeSlots) {
                                timelineItems[startSlot + i] = appointment;
                            }
                        }
                    });
                    
                    // Add the suggested new appointment (dotted outline)
                    const suggestedStartTime = new Date(nextAvailableTime);
                    const suggestedStartSlot = (suggestedStartTime.getHours() - workStartHour) * 2 + 
                                              (suggestedStartTime.getMinutes() >= 30 ? 1 : 0);
                    const suggestedDurationSlots = Math.ceil(requiredTime / 30);
                    
                    const newAppointmentBlock = document.createElement('div');
                    newAppointmentBlock.className = 'appointment-block dotted';
                    newAppointmentBlock.style.left = `${suggestedStartSlot * slotWidth}px`;
                    newAppointmentBlock.style.width = `${suggestedDurationSlots * slotWidth - 10}px`; // -10 for margins
                    newAppointmentBlock.textContent = 'New Appointment';
                    
                    // Add to timeline slots container
                    timelineSlots.appendChild(newAppointmentBlock);
                    
                    // Scroll to make the suggested time visible
                    setTimeout(() => {
                        const timelineScrollContainer = document.querySelector('.timeline-scroll-container');
                        if (timelineScrollContainer) {
                            // Calculate scroll position to center the new appointment
                            const scrollPosition = suggestedStartSlot * slotWidth;
                            timelineScrollContainer.scrollLeft = Math.max(0, scrollPosition - 100);
                        }
                    }, 100);
                    
                    // When scheduled time changes, update the dotted appointment in the timeline
                    scheduledTimeInput.addEventListener('change', function() {
                        const selectedTime = new Date(this.value);
                        
                        // Check if time is within working hours
                        if (selectedTime.getHours() < workStartHour || selectedTime.getHours() >= workEndHour) {
                            alert('Please select a time between 9 AM and 5 PM');
                            return;
                        }
                        
                        // Remove previous dotted appointment
                        const previousDotted = timelineSlots.querySelector('.dotted');
                        if (previousDotted) {
                            previousDotted.remove();
                        }
                        
                        // Calculate new position
                        const newStartSlot = (selectedTime.getHours() - workStartHour) * 2 + 
                                            (selectedTime.getMinutes() >= 30 ? 1 : 0);
                        
                        // Check for conflicts
                        let hasConflict = false;
                        for (let i = 0; i < suggestedDurationSlots; i++) {
                            if (newStartSlot + i < timeSlots && timelineItems[newStartSlot + i] !== null) {
                                hasConflict = true;
                                break;
                            }
                        }
                        
                        // Create the new appointment block
                        const updatedAppointmentBlock = document.createElement('div');
                        updatedAppointmentBlock.className = `appointment-block dotted ${hasConflict ? 'red' : ''}`;
                        updatedAppointmentBlock.style.left = `${newStartSlot * slotWidth}px`;
                        updatedAppointmentBlock.style.width = `${suggestedDurationSlots * slotWidth - 10}px`;
                        updatedAppointmentBlock.textContent = hasConflict ? 
                            'Conflict! (New Appointment)' : 'New Appointment';
                        
                        // Add to timeline slots container
                        timelineSlots.appendChild(updatedAppointmentBlock);
                        
                        if (hasConflict) {
                            scheduledTimeHelp.textContent = 'Warning: The selected time conflicts with another appointment!';
                            scheduledTimeHelp.style.color = '#ef4444';
                        } else {
                            scheduledTimeHelp.textContent = 'Selected time is available';
                            scheduledTimeHelp.style.color = 'var(--secondary-text)';
                        }
                        
                        // Scroll to make the selected time visible
                        setTimeout(() => {
                            const timelineScrollContainer = document.querySelector('.timeline-scroll-container');
                            if (timelineScrollContainer) {
                                const scrollPosition = newStartSlot * slotWidth;
                                timelineScrollContainer.scrollLeft = Math.max(0, scrollPosition - 100);
                            }
                        }, 100);
                    });
                }
                
                // Form validation
                const visitInfoForm = document.getElementById('visitInfoForm');
                if (visitInfoForm) {
                    visitInfoForm.addEventListener('submit', function(event) {
                        const doctorValue = doctorSelect.value;
                        const scheduledTimeValue = scheduledTimeInput.value;
                        
                        // Validate that doctor is selected and scheduled time is set
                        if (!doctorValue) {
                            event.preventDefault();
                            alert('Please select a doctor');
                            return;
                        }
                        
                        if (!scheduledTimeValue) {
                            event.preventDefault();
                            alert('Please select a scheduled time');
                            return;
                        }
                    });
                }
            });
        </script>
    </th:block>
</body>
</html> 