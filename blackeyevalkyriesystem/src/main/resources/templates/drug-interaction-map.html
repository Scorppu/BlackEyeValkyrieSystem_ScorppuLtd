<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/main}">
<head>
    <title>Drug Interaction Map</title>
    <link rel="stylesheet" th:href="@{/css/drug-interaction-map.css}">
    
    <!-- Add an immediate script in the head to detect and apply dark mode before page loads -->
    <script type="text/javascript">
        // Initialize dark mode immediately
        (function() {
            // Check if we're in dark mode
            const isDark = 
                document.documentElement.getAttribute('data-bs-theme') === 'dark' ||
                document.documentElement.getAttribute('data-theme') === 'dark' ||
                (document.body && document.body.classList.contains('dark-mode')) ||
                window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Force dark mode classes
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.body.classList.add('dark-mode');
                
                // This will be available to our scripts later
                window.initialDarkMode = true;
            } else {
                window.initialDarkMode = false;
            }
        })();
    </script>
</head>
<body>
    <div layout:fragment="content">
        <div class="content-wrapper">
            <div class="content-header">
                <h1>Drug Interaction Map</h1>
                <div style="display: flex; gap: 10px;">
                    <a href="/drugs/interactions" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 12L8 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4 8L12 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Manage Interactions
                    </a>
                </div>
            </div>
            
            <!-- Drug Selection -->
            <div class="drug-select-container">
                <div class="form-group">
                    <label for="drugSelect" class="form-label">Select a drug to view its interactions:</label>
                    <select id="drugSelect" class="form-select">
                        <option value="">Overview</option>
                        <option th:each="drug : ${drugs}" 
                                th:value="${drug.id}" 
                                th:text="${drug.name}">Drug name</option>
                    </select>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="map-container" id="interactionMap">
                <div id="emptyState" class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 3.6V14.4C9 14.7314 9.26863 15 9.6 15H20.4C20.7314 15 21 14.7314 21 14.4V3.6C21 3.26863 20.7314 3 20.4 3H9.6C9.26863 3 9 3.26863 9 3.6Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M6 7.5V18.3C6 18.6314 6.26863 18.9 6.6 18.9H17.4C17.7314 18.9 18 18.6314 18 18.3V18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 11.4V21.4C3 21.7314 3.26863 22 3.6 22H13.6C13.9314 22 14.2 21.7314 14.2 21.4V21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h3>Select a drug to view its interaction map</h3>
                    <p>The visualization will show the selected drug and its interactions in a bubble map.</p>
                </div>
                
                <!-- SVG container for the D3 visualization -->
                <svg id="bubbleMap" style="width: 100%; height: 100%; display: none; background-color: var(--map-bg);" width="800" height="600"></svg>
                
                <!-- Legend 
                <div id="mapLegend" class="legend" style="display: none;">
                    <div class="legend-item">
                        <div class="legend-color category-main"></div>
                        <div class="legend-text">Main Drug</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color category-high"></div>
                        <div class="legend-text">Risk Interaction</div>
                    </div>
                </div>-->
            </div>
        </div>
    </div>
    
    <!-- D3.js for visualization - using multiple CDN sources for redundancy -->
    <th:block layout:fragment="scripts">
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script th:src="@{/js/drug-interaction-map.js}"></script>
    </th:block>
</body>
</html> 